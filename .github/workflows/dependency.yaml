name: OWASP Dependency Check

on:
  workflow_dispatch:

jobs:
  dependency-check:
    name: 🛡️ OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "my-project"
          format: "ALL" # Generates JSON, XML, SARIF, HTML
          out: "reports"
          args: >
            --disableYarnAudit
            --disableNodeAudit

      - name: Fix Permissions
        run: |
          sudo chown -R $USER:$USER reports
          chmod -R u+rw reports

      - name: Pretty Print Reports
        run: |
          mkdir -p reports

          # JSON
          if [ -f reports/dependency-check-report.json ]; then
            jq '.' reports/dependency-check-report.json | tee reports/dependency-check-report.pretty.json > /dev/null
          else
            echo '{}' | tee reports/dependency-check-report.pretty.json > /dev/null
          fi

          # SARIF
          if [ -f reports/dependency-check-report.sarif ]; then
            jq '.' reports/dependency-check-report.sarif | tee reports/dependency-check-report.pretty.sarif > /dev/null
          else
            echo '{"runs":[]}' | tee reports/dependency-check-report.pretty.sarif > /dev/null
          fi

          # XML
          if [ -f reports/dependency-check-report.xml ]; then
            xmllint --format reports/dependency-check-report.xml | tee reports/dependency-check-report.pretty.xml > /dev/null
          else
            echo "<report/>" | tee reports/dependency-check-report.pretty.xml > /dev/null
          fi

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: reports/
